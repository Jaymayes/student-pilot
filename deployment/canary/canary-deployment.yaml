# Canary Deployment Configuration for ScholarLink
# Identical to production but with canary labels for traffic splitting

apiVersion: apps/v1
kind: Deployment
metadata:
  name: scholarlink-app-canary
  namespace: scholarlink-prod
  labels:
    app: scholarlink
    version: v{{ .Values.deployment.version }}
    component: api
    deployment: canary
spec:
  # Start with minimal replicas for canary
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: scholarlink
      component: api
      deployment: canary
  template:
    metadata:
      labels:
        app: scholarlink
        component: api
        deployment: canary
        version: v{{ .Values.deployment.version }}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "5000"
        prometheus.io/path: "/metrics"
        deployment.kubernetes.io/revision: "{{ .Values.deployment.version }}"
    spec:
      # Security Context (same as main deployment)
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        seccompProfile:
          type: RuntimeDefault
      
      serviceAccountName: scholarlink-app
      automountServiceAccountToken: false
      
      # Anti-affinity to avoid same node as stable deployment
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - scholarlink
              - key: deployment
                operator: In
                values:
                - stable
            topologyKey: kubernetes.io/hostname
      
      containers:
      - name: scholarlink
        # Use immutable digest-based image
        image: scholarlink@sha256:{{ .Values.deployment.imageDigest }}
        imagePullPolicy: Always
        
        ports:
        - containerPort: 5000
          name: http
          protocol: TCP
        
        # Environment from ConfigMap
        envFrom:
        - configMapRef:
            name: scholarlink-config
        
        # Additional canary-specific environment
        env:
        # Mark as canary deployment
        - name: DEPLOYMENT_TYPE
          value: "canary"
        - name: DEPLOYMENT_VERSION
          value: "{{ .Values.deployment.version }}"
        
        # Database (same as production)
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: scholarlink-database
              key: DATABASE_URL
        - name: PGHOST
          valueFrom:
            secretKeyRef:
              name: scholarlink-database
              key: PGHOST
        - name: PGPORT
          valueFrom:
            secretKeyRef:
              name: scholarlink-database
              key: PGPORT
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: scholarlink-database
              key: PGUSER
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: scholarlink-database
              key: PGPASSWORD
        - name: PGDATABASE
          valueFrom:
            secretKeyRef:
              name: scholarlink-database
              key: PGDATABASE
        
        # Application Secrets (same as production)
        - name: SESSION_SECRET
          valueFrom:
            secretKeyRef:
              name: scholarlink-app-secrets
              key: SESSION_SECRET
        - name: SHARED_SECRET
          valueFrom:
            secretKeyRef:
              name: scholarlink-app-secrets
              key: SHARED_SECRET
        - name: ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: scholarlink-app-secrets
              key: ENCRYPTION_KEY
        
        # External Services (same as production)
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: scholarlink-external
              key: OPENAI_API_KEY
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: scholarlink-external
              key: SENTRY_DSN
              optional: true
        
        # Domain Configuration for canary
        - name: CORS_ALLOWED_ORIGINS
          value: "https://scholarlink.app,https://www.scholarlink.app"
        - name: AGENT_BASE_URL
          value: "https://agent.scholarlink.app"
        
        # Volume Mounts (same as production)
        volumeMounts:
        - name: jwt-keys
          mountPath: /app/secrets
          readOnly: true
        - name: tmp
          mountPath: /tmp
        - name: app-cache
          mountPath: /app/.cache
        
        # Security Context (same as production)
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE
        
        # Resource Management (same as production)
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
            ephemeral-storage: "1Gi"
          limits:
            memory: "1Gi"
            cpu: "1000m"
            ephemeral-storage: "2Gi"
        
        # Health Checks (same timeouts, different failure thresholds)
        startupProbe:
          httpGet:
            path: /health
            port: 5000
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 20  # Reduced for faster canary feedback
        
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 2   # Reduced for faster canary feedback
        
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
            scheme: HTTP
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2   # Reduced for faster canary feedback
      
      # Volumes (same as production)
      volumes:
      - name: jwt-keys
        secret:
          secretName: scholarlink-jwt-keys
          defaultMode: 0400
      - name: tmp
        emptyDir: {}
      - name: app-cache
        emptyDir: {}
      
      # DNS Configuration
      dnsPolicy: ClusterFirst
      dnsConfig:
        options:
        - name: ndots
          value: "2"
      
      # Graceful Shutdown (reduced for faster canary iterations)
      terminationGracePeriodSeconds: 15

---
# Canary HPA (scaled down initially)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: scholarlink-hpa-canary
  namespace: scholarlink-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: scholarlink-app-canary
  minReplicas: 1
  maxReplicas: 3   # Limited during canary
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60  # Lower threshold for canary
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70  # Lower threshold for canary
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 60   # Faster scaling for canary
      policies:
      - type: Percent
        value: 100  # Can scale down quickly during canary
        periodSeconds: 15
    scaleUp:
      stabilizationWindowSeconds: 30   # Faster scaling for canary
      policies:
      - type: Percent
        value: 200  # Can scale up quickly during canary
        periodSeconds: 15