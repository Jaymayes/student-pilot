# Network security policies for ScholarLink Billing Service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: scholarlink-billing
  namespace: scholarlink-prod
spec:
  podSelector:
    matchLabels:
      app: scholarlink-billing
  policyTypes:
  - Ingress
  - Egress
  
  # Ingress rules
  ingress:
  # Allow traffic from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3000
  
  # Allow monitoring from prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 3000

  # Egress rules (default deny, explicit allow)
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Allow HTTPS to Stripe API
  - to: []
    ports:
    - protocol: TCP
      port: 443
    # Stripe IP ranges (update as needed)
    # This is a simplified example - use actual Stripe CIDR blocks
  
  # Allow connection to PostgreSQL
  - to: []
    ports:
    - protocol: TCP
      port: 5432
  
  # Allow connection to monitoring webhooks (HTTPS)
  - to: []
    ports:
    - protocol: TCP
      port: 443

---
# Additional policy for migration job
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: scholarlink-billing-migration
  namespace: scholarlink-prod
spec:
  podSelector:
    matchLabels:
      app: scholarlink-billing
      component: migration
  policyTypes:
  - Egress
  
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Allow connection to PostgreSQL
  - to: []
    ports:
    - protocol: TCP
      port: 5432