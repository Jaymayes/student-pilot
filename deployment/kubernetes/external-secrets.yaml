# External Secrets Configuration for ScholarLink Production
# Compatible with AWS Secrets Manager + External Secrets Operator

apiVersion: v1
kind: Namespace
metadata:
  name: scholarlink-prod
  labels:
    name: scholarlink-prod
    environment: production
    security.policy: restricted

---
# External Secret Store Configuration (AWS Secrets Manager)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: scholarlink-prod
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        secretRef:
          accessKeyID:
            name: aws-credentials
            key: access-key-id
          secretAccessKey:
            name: aws-credentials
            key: secret-access-key

---
# AWS Credentials for External Secrets Operator
apiVersion: v1
kind: Secret
metadata:
  name: aws-credentials
  namespace: scholarlink-prod
type: Opaque
stringData:
  access-key-id: "AKIA..." # Replace with actual IAM access key
  secret-access-key: "..." # Replace with actual IAM secret key

---
# Database Credentials from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: scholarlink-database
  namespace: scholarlink-prod
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: scholarlink-database
    creationPolicy: Owner
  data:
  - secretKey: DATABASE_URL
    remoteRef:
      key: scholarlink/prod/database
      property: DATABASE_URL
  - secretKey: PGHOST
    remoteRef:
      key: scholarlink/prod/database
      property: PGHOST
  - secretKey: PGPORT
    remoteRef:
      key: scholarlink/prod/database
      property: PGPORT
  - secretKey: PGUSER
    remoteRef:
      key: scholarlink/prod/database
      property: PGUSER
  - secretKey: PGPASSWORD
    remoteRef:
      key: scholarlink/prod/database
      property: PGPASSWORD
  - secretKey: PGDATABASE
    remoteRef:
      key: scholarlink/prod/database
      property: PGDATABASE

---
# Application Secrets from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: scholarlink-app-secrets
  namespace: scholarlink-prod
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: scholarlink-app-secrets
    creationPolicy: Owner
  data:
  - secretKey: SESSION_SECRET
    remoteRef:
      key: scholarlink/prod/app
      property: SESSION_SECRET
  - secretKey: SHARED_SECRET
    remoteRef:
      key: scholarlink/prod/app
      property: SHARED_SECRET
  - secretKey: ENCRYPTION_KEY
    remoteRef:
      key: scholarlink/prod/app
      property: ENCRYPTION_KEY
  - secretKey: WEBHOOK_SECRET
    remoteRef:
      key: scholarlink/prod/app
      property: WEBHOOK_SECRET

---
# JWT Keys from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: scholarlink-jwt-keys
  namespace: scholarlink-prod
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: scholarlink-jwt-keys
    creationPolicy: Owner
  data:
  - secretKey: jwt_private.pem
    remoteRef:
      key: scholarlink/prod/jwt
      property: private_key
  - secretKey: jwt_public.pem
    remoteRef:
      key: scholarlink/prod/jwt
      property: public_key

---
# External Service Secrets from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: scholarlink-external
  namespace: scholarlink-prod
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: scholarlink-external
    creationPolicy: Owner
  data:
  - secretKey: OPENAI_API_KEY
    remoteRef:
      key: scholarlink/prod/external
      property: OPENAI_API_KEY
  - secretKey: SENTRY_DSN
    remoteRef:
      key: scholarlink/prod/external
      property: SENTRY_DSN
  - secretKey: SMTP_USER
    remoteRef:
      key: scholarlink/prod/external
      property: SMTP_USER
  - secretKey: SMTP_PASS
    remoteRef:
      key: scholarlink/prod/external
      property: SMTP_PASS