# MASTER LOGIN-ROUTING FIX + E2E TEST PROTOCOL (A1 Internal Only; Users â†’ A5/A6)

ROLE: Senior SDET/DevOps  
OBJECTIVE: For the single application you are currently assigned to, (1) verify and fix login routing so end-users land ONLY in A5 (Student) or A6 (Provider) and are blocked from A1, and (2) run an E2E test to prove there are no loops, no A1 exposure, and no revenue blockers.

--------------------------------------------------------------------------------
## ðŸ›‘ PHASE 1 â€” STRICT LOGIC GATE (IDENTIFY â†’ LOCK â†’ HANDSHAKE)

You have instructions for three apps. You must NOT touch them all.

1) DETECT (exactly one app)
   - Determine your App ID via:
     - Environment: APP_ID, APP_NAME, APP_BASE_URL
     - package.json name/homepage or repository folder name
     - Server config (.env.*, basePath/origin, deploy logs)
     - Deployed origin in settings (preferred)
   - Match to the registry below.

2) LOCK (isolate scope)
   - Once identified, IGNORE all other app sections.
   - If multiple or zero matches: STOP and print the ABORT message with inspected candidates.

3) HANDSHAKE (print EXACTLY before any action)
> ðŸ” AGENT IDENTITY CONFIRMED  
> CURRENT APP ID: [Insert Detected ID]  
> TARGET URL: [Insert Detected URL]  
> ACTION: Locking context. Executing login-routing remediation + E2E for [Insert ID] only.

If you cannot determine your app confidently:
> âŒ ABORT: Unable to determine single App ID with confidence. No actions executed.

--------------------------------------------------------------------------------
## ðŸ“‚ APPLICATION REGISTRY (SCOPE FOR THIS TASK)

| APP ID           | BASE URL (APP_BASE_URL)                                   | ROLE               |
|------------------|------------------------------------------------------------|--------------------|
| A1 scholar_auth  | https://scholar-auth-jamarrlmayes.replit.app               | INTERNAL ONLY      |
| A5 student_pilot | https://student-pilot-jamarrlmayes.replit.app              | PUBLIC (Students)  |
| A6 provider_register | https://provider-register-jamarrlmayes.replit.app      | PUBLIC (Providers) |

Constraint: Endâ€‘users must only use A5 or A6. A1 is restricted to internal/admin/service accounts.

--------------------------------------------------------------------------------
## ðŸ§· GLOBAL GUARDRAILS

- Nonâ€‘destructive first: Prefer GET/readâ€‘only. Writes only if isolated, labeled â€œE2E Test,â€ and cleaned up.
- Redact tokens, secrets, cookies, emails â†’ ****
- Rate limit â‰¤ 1 RPS; back off on 429/503.
- Crossâ€‘app changes forbidden: If another app needs change, file a ticket (templates in Phase 6) and STOP.

--------------------------------------------------------------------------------
## ðŸ§¯ PHASE 2 â€” REMEDIATION SUITES (EXECUTE ONLY YOUR APP SECTION)

Use conditional logic: if a check fails, apply the listed fix; otherwise skip the fix and continue.

### ðŸ”´ A1 â€” scholar_auth (INTERNAL ONLY; must not be a user landing surface)
Fix goals: Nonâ€‘admin users cannot use A1; successful auth returns users to A5/A6 only; no â€œstuck on Authorizeâ€ loops.

1) Internalâ€‘only gate (RBAC)
   - Try to access A1 / or /dashboard as an unauthenticated user â†’ must NOT render internal UI.
   - If accessible:
     - Add middleware: if user.role âˆ‰ {admin, service} then 403 or 302 â†’ A5_BASE_URL (preferred: 302 to A5).
     - Reâ€‘test access (must be denied or redirected).

2) OIDC client registrations (callback routing)
   - Verify registered redirect_uris and post_logout_redirect_uris include ONLY:
     - A5: https://student-pilot-jamarrlmayes.replit.app/api/callback
     - A6: https://provider-register-jamarrlmayes.replit.app/api/callback
   - If A1 URLs are present as user-facing callbacks â†’ open ticket to remove/disable them (Phase 6), STOP local changes.

3) Default afterâ€‘signâ€‘in routing (env)
   - Ensure AFTER_SIGN_IN_URL / DEFAULT_POST_LOGIN_URL points to A5 (or A6 for provider flows).
   - If missing/wrong â†’ set:
     - A1_DEFAULT_AFTER_SIGN_IN_URL=https://student-pilot-jamarrlmayes.replit.app
     - A1_DEFAULT_AFTER_SIGN_UP_URL=https://student-pilot-jamarrlmayes.replit.app
   - Reâ€‘test login: must return to A5, not A1.

4) â€œAuthorize Applicationâ€ loop detector (fixâ€‘if)
   - Symptoms: Browser stuck on consent/authorize or bounce between A1/A5.
   - Fix checks:
     - Redirect URI exact match (scheme/host/path, no trailing slash drift).
     - PKCE: code_verifier stored serverâ€‘side/session cookie (not sessionStorage); S256 enabled.
     - Cookies: Secure, HttpOnly, SameSite=None; trust proxy set.
     - CORS: allow A5/A6 exact origins with credentials; no wildcard+credentials.
   - Reâ€‘test: no loop; completes within â‰¤ 8s.

### ðŸ”µ A5 â€” student_pilot (PUBLIC STUDENT)
Fix goals: All user logins land here; manual A1 navigation blocked; no routing loops.

1) Login button target
   - Inspect login button/link configs: must send users to A1 authorize with redirect_uri=A5/api/callback.
   - If not â†’ update env/UI to use A5 callback and A1 issuer.

2) Postâ€‘login route
   - Ensure AFTER_SIGN_IN_URL (or equivalent) routes to A5 dashboard/home.
   - If missing/wrong â†’ set NEXT_PUBLIC_AFTER_SIGN_IN_URL=/dashboard (or absolute A5 URL if required by stack).

3) Manual A1 access block (user perspective)
   - While authenticated in A5, open A1 base URL: must 403 or 302 back to A5.
   - If not â†’ open A1 RBAC ticket (Phase 6).

### ðŸŸ£ A6 â€” provider_register (PUBLIC PROVIDER)
Fix goals: Providers land here postâ€‘auth; A1 remains internal.

1) Login target and callback
   - Ensure login initiates A1 authorize with redirect_uri=A6/api/callback.
   - If wrong â†’ update env/UI to A6 callback.

2) Postâ€‘login route
   - Ensure AFTER_SIGN_IN_URL= /onboarding or provider dashboard in A6.

3) Manual A1 access block (user perspective)
   - While authenticated in A6, open A1: must 403 or 302 to A5/A6.
   - If not â†’ open A1 RBAC ticket.

--------------------------------------------------------------------------------
## âš™ï¸ PHASE 3 â€” E2E TESTS (RUN ONLY YOUR APPâ€™S SUITE)

All tests must start in a fresh Incognito/private session. Capture method, URL, status, duration, and a oneâ€‘line assertion per step (redact secrets).

A) Student flow (A5 as the system of record)
1) Start at A5 / â†’ page renders 200 (no fatal console errors).
2) Click â€œSign inâ€ â†’ A1 authorize screen appears (1 hop); continue with Google.
3) Callback lands at A5 /dashboard (NOT A1) within â‰¤ 8s; document.origin is A5.
4) Manually open A1 base URL â†’ expect 403 or 302 back to A5 (assert internal gate works).
5) Logout â†’ returns to A5 public home.

B) Provider flow (A6 as the system of record)
1) Start at A6 / â†’ page renders 200 (no fatal console errors).
2) Click â€œSign inâ€ â†’ A1 authorize; continue.
3) Callback lands at A6 /onboarding (NOT A1) within â‰¤ 8s.
4) Manually open A1 base â†’ 403 or 302 back to A6/A5 (internal gate works).
5) Logout â†’ returns to A6 landing.

C) Loop sentinel (must not be stuck)
- If you observe repeated â€œAuthorize Applicationâ€ screen or bouncing:
  - Record status/headers from callback.
  - Run the fixâ€‘if list in A1 step 4 (PKCE/cookies/CORS/redirect exactness).
  - Reâ€‘run flow until loop disappears.

--------------------------------------------------------------------------------
## ðŸ§ª PHASE 4 â€” EVIDENCE & ASSERTIONS

- Evidence for each step: Method, URL, Status, Duration(ms), and assertion.
- Headers: Only record Setâ€‘Cookie flags (Secure/HttpOnly/SameSite) and CORS (no values).
- Redact: All tokens/secrets/cookies â†’ ****

--------------------------------------------------------------------------------
## ðŸ PHASE 5 â€” REQUIRED OUTPUTS

1) Test summary table
| Test Case                                   | Status | Notes / Error Log (Redacted)                  |
|---------------------------------------------|--------|-----------------------------------------------|
| A5 login lands at A5 (not A1)               |        |                                               |
| A6 login lands at A6 (not A1)               |        |                                               |
| A1 manual access (nonâ€‘admin) blocked        |        |                                               |
| Loop sentinel (no stuck authorize screen)   |        |                                               |

2) Routingâ€‘risk verdict
| Check                                | Status (PASS/FAIL) | Risk | Notes (Redacted)                           |
|--------------------------------------|--------------------|------|--------------------------------------------|
| A5 default afterâ€‘signâ€‘in correct     |                    | High |                                            |
| A6 default afterâ€‘signâ€‘in correct     |                    | High |                                            |
| A1 RBAC gate (nonâ€‘admin blocked)     |                    | High |                                            |
| Callback exactness (URIs match)      |                    | High |                                            |
| PKCE/cookies/CORS alignment          |                    | Med  |                                            |
VERDICT: [SAFE â€” USERS CONFINED TO A5/A6] or [BLOCKED â€” ACTIONS REQUIRED]

--------------------------------------------------------------------------------
## ðŸš« PHASE 6 â€” ABORT & TICKETS (WHEN CROSSâ€‘APP CHANGES ARE NEEDED)

Abort (fail fast)
- Multiple/zero App ID matches â†’ ABORT with candidates inspected.
- Production + no test creds â†’ SKIP destructive steps; continue readâ€‘only; mark SKIPPED.
- Repeated 5xx on auth critical path (>2) â†’ stop writes; proceed readâ€‘only; mark SKIPPED.

Ticket templates (copy, fill, and attach evidence)
- Title: A1 RBAC Gate â€” Block Nonâ€‘Admin Access
  - App: scholar_auth (A1)
  - Need: Middleware to 403/302 nonâ€‘admin users away from A1
  - Evidence: A1 accessible to student/provider (screens + headers)

- Title: A1 Client Registration â€” Correct Redirect URIs
  - App: scholar_auth (A1)
  - Redirect URIs:
    - https://student-pilot-jamarrlmayes.replit.app/api/callback
    - https://provider-register-jamarrlmayes.replit.app/api/callback
  - Postâ€‘logout URIs: A5/A6 home
  - Evidence: invalid_redirect_uri or misrouted landings

- Title: A5/A6 Afterâ€‘Signâ€‘In URL â€” Route to App Home
  - App: [A5 or A6]
  - Need: Set AFTER_SIGN_IN_URL to /dashboard (A5) or /onboarding (A6)
  - Evidence: Landing at A1 or stuck on authorize
