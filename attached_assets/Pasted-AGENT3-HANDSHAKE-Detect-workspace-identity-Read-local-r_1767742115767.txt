AGENT3_HANDSHAKE

Detect workspace identity:
Read local repo/workspace slug and any configured staging base URL from environment or code.
Match against the APPS TABLE (id, name, repo_hint, base_url_staging).
Set:
ASSIGNED_APP = one of {A1,A2,A3,A4,A5,A6,A7,A8}
APP_BASE_URL = matched staging URL (or discovered endpoint)
REPO_NAME = local repo/workspace name
VERSION = current git sha (or git_sha_dynamic)
ACK: I will only execute the tasks inside “YOUR APP SECTION [ASSIGNED_APP]”. All other app sections are read-only context. I start in Diagnostic Mode. No production mutations without HUMAN_APPROVAL_REQUIRED.
APPS TABLE (Handshake Reference)

A1 scholar_auth | repo_hint: scholar-auth | base_url_staging: https://scholar-auth-jamarrlmayes.replit.app
A2 scholar_api_aggregator | repo_hint: scholar-api | base_url_staging: internal_discovery
A3 scholarship_agent | repo_hint: scholarship_agent | base_url_staging: internal_discovery
A4 scholar_sage | repo_hint: scholar-sage | base_url_staging: internal_discovery
A5 student_pilot | repo_hint: student-pilot | base_url_staging: https://student-pilot-jamarrlmayes.replit.app
A6 provider_register | repo_hint: provider-register | base_url_staging: https://provider-register-jamarrlmayes.replit.app
A7 scholar_pagemaker | repo_hint: scholar-pagemaker | base_url_staging: https://scholaraiadvisor.com
A8 scholar_command_center | repo_hint: scholar-command-center | base_url_staging: https://auto-com-center-jamarrlmayes.replit.app
GLOBAL POLICY & ORCHESTRATOR (Read-Only Context)

Modes:
Diagnostic Mode (default): read-only, staging-first probes and cross-app checks.
Staging Fix Mode: allowed. Branch → implement safe fix → run tests → stage deploy → validate → open PR. Pause for HUMAN_APPROVAL_REQUIRED before any production change.
Production Change Mode: requires explicit HUMAN_APPROVAL_REQUIRED.
Environment/Tags:
Staging is primary; production is diagnostics-only (no writes, migrations, or config changes).
Tag all synthetic events: env=staging, namespace=simulated_audit, version=${VERSION}.
SLO Targets:
Latency P95 ≤ 150 ms for critical staged flows.
0% 5xx error rate in simulated flows (any 5xx requires evidence).
Evidence Rules:
No issue is valid without logs/traces/DB records and, where applicable, A8 visibility tied to the same event_id.
Human-in-the-Loop Gates (STOP CONDITIONS → require HUMAN_APPROVAL_REQUIRED):
Production writes; secret rotation/creation; enabling/disabling A8 write scopes; schema/alert changes; deployment restarts; cost-impacting autoscale; PR merges to main; any action that could expose sensitive data or alter security posture.
Constraints:
Never print secrets; verify presence by name only.
Operate only within YOUR APP SECTION; cross-app work must remain read-only and safe.
GLOBAL VERIFICATION PLAN

Discovery:
Produce system_map.json (Service → Purpose → Dependencies → Required secrets by name → Health endpoints → Inbound/Outbound APIs → A8 sinks/sources).
Produce connectivity_matrix.csv via non-destructive staging probes (status, auth type, latency).
Observability:
Produce slo_metrics.json: trailing 24h/7d P50/P95/P99 and error rates for accessible staging endpoints.
Ensure staged tests emit structured logs with trace_id and request_context.
Security & Resiliency:
Validate TLS on all hops; verify internal token-based auth; confirm OIDC state/nonce where relevant.
In staging, inject 500 ms latency and simulate 503; verify retries/backoff and circuit-breaker behavior; document configs and results in resiliency_config.md.
Data Quality & Lineage to A8:
Validate Avro/JSON schemas; require tags env/namespace/version.
Prove lineage: event_id → A2 aggregator → A8 raw storage → A8 dashboards; export queries/evidence to a8_data_lineage.md and a8_validation_results.json.
Performance/Cost Hotspots:
Detect synchronous HTTP chains > 200 ms end-to-end; recommend async/queue refactors with estimated impact.
E2E WORKFLOWS (Run only steps that involve your app; stub others safely)

Marketing_SEO_A7: Sitemap → Indexing → Attribution → A8 SEO tile.
Lead_Gen_A5_A1_A3: Signup → OIDC → CRM capture → event bus (idempotency) → A8 Growth tile.
B2B_Revenue_A6_A2_A8: Provider funnel (Lead→Demo→Contract→Live); simulate $1000 GMV and $10 AI cost; verify 3% platform fee ($30) and 4x markup ($40) posted; confirm A8 Finance tile.
Learning_A5_A4: Doc ingest → essay AI → success metric → A8 Outcomes tile.
RL ERROR-CORRECTION LOOP (Documented; no merges without approval)

Monitor → Reflect (capture failure evidence) → Synthesize regression test (namespace=simulated_audit) → Propose PR fix (branch) → Verify (reward: fewer errors, improved P95, higher E2E pass rate) → Update docs/runbooks. Do not merge PRs or promote to production without HUMAN_APPROVAL_REQUIRED.
EGRS (Enterprise Grade Readiness Score)

Compute egrs_score.json using weights:
Security 15; Auth_Health 10; Reliability 15; Observability 10; Data_Quality_A8 15; E2E_Workflows 15; Performance 10; Cost_Scale 5; Human_Gates 5.
Thresholds:
Ready ≥ 85; Conditional ≥ 70 and < 85; Not_Ready < 70.
Summarize EGRS and “Path to Ready” in exec_summary.md.
GLOBAL DELIVERABLES

Write to reports/scholar_audit/YYYYMMDD-HHMM/:
exec_summary.md; rca.md; system_map.json; connectivity_matrix.csv; slo_metrics.json; security_checklist.md; resiliency_config.md; e2e_results.json; a8_validation_results.json; a8_data_lineage.md; risk_register.md; cleanup_audit.sh; docs_update_plan.md; egrs_score.json.
GLOBAL KNOWN ISSUES (map into app sections by id prefix)

A1-001 OIDC Session Expired Loop (High) — cookies/TTL mismatch; confirm with 10 staged login runs.
A4-001 LLM Latency/Cold Starts (Medium) — P95 borderline/exceeded under load; cache warm/load test.
A5-001 Routes/Env Config (Low) — 404 resolved; AUTO_PAGE_MAKER_URL set; confirm env loaded at runtime.
A6-001 External Deployment Stale (Critical) — external 500; compare env/migrations; staging OK; verify billing logic.
A8-001 Revenue Blindness/Tile Wiring (Medium) — central lacks business keys; fallback merges; verify Stripe read config with synthetic events.
GLOBAL REQUIRED SECRETS (verify presence by name only; never print values)

OIDC_ISSUER, CLIENT_ID, CLIENT_SECRET, COOKIE_SECRET, A2_API_KEY, DB_URL, A8_INGEST_KEY, BANDIT_CONFIG, STRIPE_KEY, LLM_API_KEY, AUTH_CLIENT_ID, AUTO_PAGE_MAKER_URL, DATABASE_URL, STRIPE_SECRET_KEY, CMS_API_KEY, SEO_CONFIG, ADMIN_API_KEY, READ_ONLY_LOCK, STRIPE_READ_KEY
GLOBAL KEY ENDPOINTS (use only those relevant to your app)

/oidc/auth, /oidc/token, /health, /ready, /v1/events, /preflight, /orchestration_run, /chat/completions, /dashboard, /hub/upload, /register, /api/billing, /sitemap.xml, /api/ingest, /dashboard/status
YOUR APP SECTION [A1: scholar_auth] — Execute only if ASSIGNED_APP=A1

Key endpoints: /oidc/auth, /oidc/token, /health
Validate known issue A1-001:
Full redirect-chain trace; inspect Set-Cookie flags (SameSite=None, Secure=True) and Domain on replit.app; validate client_id allowlist; introduce interaction delays to test TTL; run 10 consecutive login flows; record failures with trace_id.
Staging Fix Mode (auto_remediation_playbook):
Branch fix/oidc-cookies → set SameSite=None Secure=True where appropriate; extend interaction TTL; stage deploy; verify 10/10 passes; open PR; pause for approval.
Success criteria:
10/10 successful OIDC flows; P95 auth ≤ 150 ms.
Deliverables_local:
auth_trace_log.json; oidc_config_audit.md.
YOUR APP SECTION [A2: scholar_api_aggregator] — Execute only if ASSIGNED_APP=A2

Key endpoints: /v1/events, /health, /ready
Tasks:
Confirm /ready returns 200; profile ingest latency (P50/P95/P99); verify 100% persistence to A8; validate A8_INGEST_KEY presence by name; ensure no WAF blocks JWT headers.
Success criteria:
/ready 200; P95 ingest ≤ 125 ms; 100% persistence.
Deliverables_local:
ingestion_latency_metrics.csv.
YOUR APP SECTION [A3: scholarship_agent] — Execute only if ASSIGNED_APP=A3

Key endpoints: /preflight, /orchestration/run
Validate prior triage:
Run /preflight; verify bandit_config and app_identity; ensure idempotency keys and scopes to A2; emit synthetic revenue events with correct tags; confirm acceptance in A2/A8.
Success criteria:
Preflight passes; synthetic revenue events land in A2/A8 with correct tags.
Deliverables_local:
agent_preflight_audit.log.
YOUR APP SECTION [A4: scholar_sage] — Execute only if ASSIGNED_APP=A4

Key endpoints: /chat/completions, /health
Validate known issue A4-001:
Load test with cache warm; capture latency and resource usage; identify GC/cold-start bottlenecks.
Staging Fix Mode (auto_remediation_playbook):
Branch perf/llm-optim → implement cache warming and GC tuning; add lightweight health; stage deploy; validate P95; open PR; pause for approval.
Success criteria:
P95 ≤ 150 ms under load.
Deliverables_local:
llm_latency_profile.csv.
YOUR APP SECTION [A5: student_pilot] — Execute only if ASSIGNED_APP=A5

Key endpoints: /dashboard, /hub/upload, /health
Validate known issue A5-001:
Confirm correct login route (e.g., /api/login) and status semantics; verify AUTO_PAGE_MAKER_URL availability at runtime (restart if env changes are needed).
E2E duties:
Signup → OIDC → CRM capture → bus with idempotency; confirm A8 Growth tile.
Doc ingest → A4 essay AI → success metric; confirm A8 Outcomes tile.
Staging Fix Mode (if needed):
Branch fix/routes-config; ensure env loaded; stage deploy; PR; pause for approval.
Success criteria:
Login succeeds; lead event to A2; Growth and Outcomes tiles update.
Deliverables_local:
student_flow_results.json.
YOUR APP SECTION [A6: provider_register] — Execute only if ASSIGNED_APP=A6

Key endpoints: /register, /health, /api/billing
Validate known issues:
A6-001: External 500. Compare env var presence (names only) and external DB migration status with staging; capture provider_stack_trace.log.
A6-002: Simulate $1000 GMV and $10 AI cost; verify platform fee=3% ($30) and AI markup=4x ($40) posted to Finance; confirm A8 Finance tile.
Staging Fix Mode (auto_remediation_playbook):
Branch fix/ext-deployment → verify migrations and secrets by name; confirm staging funnel + billing logic; stage deploy; open PR with “publish external deployment” plan. Production publish requires HUMAN_APPROVAL_REQUIRED.
Success criteria:
External /register 200; Finance tile shows 3% and 4x events with correct tags.
Deliverables_local:
provider_stack_trace.log; billing_logic_verification.md; provider_funnel_tests.json.
YOUR APP SECTION [A7: scholar_pagemaker] — Execute only if ASSIGNED_APP=A7

Key endpoints: /sitemap.xml, /health
Tasks:
Validate sitemap size (> 2500 pages) and hub pages; emit attribution events with required tags; confirm A8 SEO tile updates.
Success criteria:
Sitemap > 2500; attribution events visible in A8.
Deliverables_local:
sitemap_validation.json.
YOUR APP SECTION [A8: scholar_command_center] — Execute only if ASSIGNED_APP=A8

Key endpoints: /api/ingest, /dashboard/status, /health
Validate known issue A8-001:
Confirm fallback merges only when central aggregator lacks business keys; reconcile “apps connected” vs raw ingestion; verify Stripe read config; ensure dashboards include namespace=simulated_audit.
Staging Fix Mode (auto_remediation_playbook):
Branch fix/dash-wiring → update dashboard queries/SQL to include namespace=simulated_audit; ensure revenue derived from real payload.value (no heuristics); keep READ_ONLY_LOCK unchanged; stage deploy; PR; pause for approval.
Success criteria:
All tiles (Growth, Finance, SEO, Outcomes) populate with simulated_audit data; lineage proven.
Deliverables_local:
a8_ingestion_validation.json; audit_status_panel_update.json.
EXECUTION ORDER

Global Discovery → Build system_map.json and connectivity_matrix.csv; export slo_metrics.json; send a minimal namespaced synthetic event to confirm A8 schema/tags acceptance.
App Diagnostics/Fixes → Execute YOUR APP SECTION; if needed, enter Staging Fix Mode (branch → fix → stage → validate → PR). Pause for HUMAN_APPROVAL_REQUIRED before any production change.
Global E2E → Run relevant E2E workflows; for B2B revenue, verify 3% fee and 4x markup and confirm A8 Finance tile; update a8_validation_results.json and a8_data_lineage.md.
Reporting & Cleanup → Compute EGRS and write egrs_score.json; produce exec_summary.md with “Path to Ready” to ≥85; update A8 (staging) Audit Status panel (read-only) with links to artifacts; provide cleanup_audit.sh and perform a dry-run.