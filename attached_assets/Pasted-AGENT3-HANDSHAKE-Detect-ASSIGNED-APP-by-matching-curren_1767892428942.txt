AGENT3_HANDSHAKE

Detect ASSIGNED_APP by matching current environment to the apps array below using any of: repo name match (repo_hint), base URL match (base_url_staging), or deployment metadata; then set context variables:
ASSIGNED_APP: One of A1–A8
APP_BASE_URL: From the apps array; if “internal_discovery,” resolve via tests/perf/config/targets.yaml or A8’s service registry; otherwise, use the provided HTTPS URL
REPO_NAME: From git remote or workspace slug; must align to repo_hint
VERSION: Current git SHA (short)
Apps:
A1 scholar_auth | repo_hint: scholar-auth | base_url_staging: https://scholar-auth-jamarrlmayes.replit.app
A2 scholar_api_aggregator | repo_hint: scholar-api | base_url_staging: internal_discovery
A3 scholarship_agent | repo_hint: scholarship_agent | base_url_staging: internal_discovery
A4 scholar_sage | repo_hint: scholar-sage | base_url_staging: internal_discovery
A5 student_pilot | repo_hint: student-pilot | base_url_staging: https://student-pilot-jamarrlmayes.replit.app
A6 provider_register | repo_hint: provider-register | base_url_staging: https://provider-register-jamarrlmayes.replit.app
A7 scholar_pagemaker | repo_hint: scholar-pagemaker | base_url_staging: https://scholaraiadvisor.com
A8 scholar_command_center | repo_hint: scholar-command-center | base_url_staging: https://auto-com-center-jamarrlmayes.replit.app
Status snapshot for situational awareness: DEGRADED (A1 Auth Loop, A6 External 500, A8 Tile Wiring)
GLOBAL POLICY & ORCHESTRATOR

Orchestrator: A8 (scholar_command_center) is the telemetry sink, visualization layer, and audit authority; all validation data must route to A8 with lineage.
Global policy:
Mode: Read-Only/Diagnostic-first; Staging Fix Mode allowed (Branch → Fix → Stage → Validate → PR); Production Change Mode strictly requires HUMAN_APPROVAL_REQUIRED.
Environment: staging primary; production read-only diagnostics only.
Namespace tags (mandatory on every synthetic event, log context, and artifact): {env: "staging", namespace: "simulated_audit", version: "git_sha_dynamic"}.
SLO targets: latency P95 ≤ 150ms; error_rate_5xx_target = 0% in simulated flows.
Constraints: Never print secrets; never mutate production; operate only within YOUR APP SECTION; synthetic events must include namespace tags; provide idempotent cleanup.
Second-Confirmation Protocol (mandatory): For every claim, collect two independent evidence sources (e.g., logs/traces/db records AND A8 telemetry tiles/metrics) tied to the same event_id/trace_id. No PASS without dual-source corroboration.
Zero-Mock Rule: Use real staging systems and real data paths end-to-end for A1–A8. No mocks for ecosystem paths. If an external third-party dependency exists outside A1–A8 and poses risk, use a safe, no-side-effect staged stub or test tenant while preserving real network calls and headers; document the stub in security_checklist.md.
Verification plan:
Discovery: generate system_map.json and connectivity_matrix.csv; enumerate required secrets by name; verify health/ready endpoints for all apps.
Observability checks: confirm logs/traces include trace_id/event_id; collect trailing 24h/7d SLO snapshots where available.
Security & resiliency: TLS on all hops; no hard-coded secrets; internal API tokens verified; OIDC state/nonce validation; resiliency probes (inject 500ms latency in staging, simulate 503 with approval; observe retries/backoff and circuit-breaker behavior).
Evidence rules: No issue is valid without logs/traces/db records and, where applicable, A8 visibility tied to the same event_id (lineage Source → A2 → A8 raw → A8 dashboards).
Human-in-the-loop gates (require explicit HUMAN_APPROVAL_REQUIRED): Production writes; secret rotation/creation; enabling/disabling A8 write scopes; schema/alert changes; deployment restarts; cost-impacting autoscale; PR merges to main.
Performance/cost hotspots: Detect synchronous chains > 200ms; recommend async/queue refactors and caching; document in rca.md and docs_update_plan.md.
YOUR APP SECTIONS [A1–A8]
Execute only the block matching the detected ASSIGNED_APP. For each block: diagnose known_issues, probe key_endpoints, apply the auto_remediation_playbook in Staging Fix Mode, validate success_criteria with dual evidence, and produce deliverables_local. Use e2e_roles to understand your role in funnels. All synthetic events must include {env, namespace, version} tags and carry trace_id and event_id.

[A1] scholar_auth — Role: IdP for Student/Provider

Known issues:
A1-001 OIDC Session Expired Loop (High): Diagnostics trace shows cookies/TTL mismatch; P95 ~121ms. Tests: run 10 consecutive login flows in staging with interaction delay.
Key endpoints: /oidc/auth, /oidc/token, /health, /ready, /v1/events, /dashboard/status
Auto-remediation playbook: Branch 'fix/oidc-cookies'; set SameSite=None and Secure=True; extend interaction TTL; stage deploy; run 10/10 login tests; open PR; pause for HUMAN_APPROVAL_REQUIRED.
Success criteria: 10/10 successful OIDC flows; P95 auth ≤ 150ms.
Deliverables local: auth_trace_log.json, oidc_config_audit.md.
[A2] scholar_api_aggregator — Role: Central Ingest → A8

Known issues: None listed; verify ingest and persistence.
Key endpoints: /health, /ready, /api/ingest, /v1/events, /dashboard/status
Auto-remediation playbook: Ensure endpoint tagging; enforce latency tiers (single ≤125ms, batch ≤200ms); validate 100% persistence; confirm API keys and schema passthrough to A8.
Success criteria: /ready returns 200; P95 ingest ≤ 125ms; 100% persistence; events visible in A8 with correct tags.
Deliverables local: ingestion_latency_metrics.csv.
[A3] scholarship_agent — Role: Lead matcher; revenue event generator

Known issues: Validate orchestration, idempotency keys, circuit breakers.
Key endpoints: /preflight, /orchestration/run, /v1/events, /health
Auto-remediation playbook: Require idempotency keys on orchestration; validate circuit breakers (Email, S2S Auth, Auto Com Center, Scholarship API) are CLOSED; add retry-with-jitter/backoff; generate k6 orchestration script if missing.
Success criteria: Preflight passes; events land in A2/A8 with correct tags; error rate <1% under baseline.
Deliverables local: agent_preflight_audit.log.
[A4] scholar_sage — Role: LLM for Learning

Known issues:
A4-001 LLM Latency/Cold Starts (Medium): P95 borderline/exceeded; memory pressure suspected. Tests: load test /chat/completions with cache warming enabled.
Key endpoints: /chat/completions, /health, /ready
Auto-remediation playbook: Branch 'perf/llm-optim'; implement cache warming and GC tuning; add lightweight health check; stage deploy; validate P95; PR.
Success criteria: P95 ≤ 150ms under load.
Deliverables local: llm_latency_profile.csv.
[A5] student_pilot — Role: Student frontend; lead capture; Learning

Known issues:
A5-001 Routes/Env Config (Low): Previous 404 resolved; AUTO_PAGE_MAKER_URL set; restart may be required. Tests: verify env var availability at runtime.
Key endpoints: /health, /dashboard, /hub/upload, /api/login
Auto-remediation playbook: Branch 'fix/routes-config' if needed; confirm /api/login route; ensure AUTO_PAGE_MAKER_URL env var loaded; stage deploy; PR.
Success criteria: Login succeeds; lead event to A2; Growth and Outcomes tiles update in A8.
Deliverables local: student_flow_results.json.
[A6] provider_register — Role: Provider onboarding; 3% fee + 4x markup emission

Known issues:
A6-001 External Deployment Stale (500) (Critical): External URL returns 500; local/staging passes; billing logic needs verification. Tests: compare env vars and migration status between staging and external.
Key endpoints: /register, /api/billing, /health
Auto-remediation playbook: Branch 'fix/ext-deployment'; verify migrations and secrets by name; confirm staging funnel and billing logic (3% fee, 4x markup); PR with publish plan; HUMAN_APPROVAL_REQUIRED for production publish.
Success criteria: External /register 200; Finance tile shows 3% and 4x events in A8.
Deliverables local: provider_stack_trace.log, billing_logic_verification.md, provider_funnel_tests.json.
[A7] scholar_pagemaker — Role: Marketing/SEO; attribution events

Known issues: Validate sitemap size and attribution emission; ensure sitemap.xml excluded from global 150ms threshold via tag.
Key endpoints: /sitemap.xml, /health, core page routes
Auto-remediation playbook: Validate sitemap > 2500 entries; ensure attribution events publish to A8 with correct tags; tag routes to exclude sitemap from 150ms threshold; tune cache/CDN.
Success criteria: Sitemap > 2500; attribution events present in A8.
Deliverables local: sitemap_validation.json.
[A8] scholar_command_center — Role: Telemetry sink; visualization; audit reporting

Known issues:
A8-001 Revenue Blindness/Tile Wiring (Medium): Revenue derived from real payload.value; tiles mixed GREEN/YELLOW; central lacks keys. Tests: verify fallback merge logic and Stripe read config with synthetic events.
Key endpoints: /dashboard, /dashboard/status, /v1/events (ingest)
Auto-remediation playbook: Branch 'fix/dash-wiring'; ensure dashboards include namespace=simulated_audit; verify fallback merges only when central lacks keys; fix Stripe read config; stage deploy; PR. Do not alter locks/scopes.
Success criteria: Tiles populate with simulated_audit data; lineage proven end-to-end.
Deliverables local: a8_ingestion_validation.json, audit_status_panel_update.json.
Required secrets (validate presence by name; never print):
OIDC_ISSUER, CLIENT_ID, CLIENT_SECRET, COOKIE_SECRET, A2_API_KEY, DB_URL, A8_INGEST_KEY, BANDIT_CONFIG, STRIPE_KEY, LLM_API_KEY, AUTH_CLIENT_ID, AUTO_PAGE_MAKER_URL, DATABASE_URL, STRIPE_SECRET_KEY, CMS_API_KEY, SEO_CONFIG, ADMIN_API_KEY, READ_ONLY_LOCK, STRIPE_READ_KEY.

Global probe catalog (use per-app as relevant):
/oidc/auth, /oidc/token, /health, /ready, /v1/events, /preflight, /orchestration/run, /chat/completions, /dashboard, /hub/upload, /register, /api/billing, /sitemap.xml, /api/ingest, /dashboard/status.

FUNNEL-UNBLOCK PROTOCOL (CRITICAL)

Objective: Diagnose and repair the end-to-end B2C/B2B funnels across A7 → A5/A1 → A3 → A2 → A6 → A8. Prove liveness, autonomy, error-correction learning, reinforcement learning, and human-in-the-loop enforcement with dual evidence.
Steps:
Establish a trace_id and idempotency_key for each funnel run; attach {env:staging, namespace:simulated_audit, version:git_sha_dynamic}.
For each hop, collect dual evidence:
Source system logs/traces/db records with the same trace_id/event_id.
A8 telemetry confirmation (ingest/raw + dashboard tile: SEO, Growth, Finance, Outcomes) for the same event_id.
Emit idempotent synthetic events via real staging endpoints; confirm duplicate-prevention on retries; record idempotency verification.
Finance lineage validation at A6 → A8: provider_fee_pct = 3 and ai_markup_factor = 4.0 must match in A6 logs and A8 Finance tile using the identical event_id.
If any hop lacks dual evidence, stop that funnel run, open a local issue entry in false_positive_register.md, propose fix-forward in Staging Fix Mode, and re-run until PASS.
E2E WORKFLOWS

Marketing_SEO_A7: Sitemap → Indexing → Attribution → A8 SEO tile.
Lead_Gen_A5_A1_A3: Signup → OIDC → CRM capture → event bus (idempotency) → A8 Growth tile.
B2B_Revenue_A6_A2_A8: Provider funnel (Lead → Demo → Contract → Live) → validate fee=3% and AI markup=4x → A8 Finance tile updates.
Learning_A5_A4: Doc ingest → essay AI → success metric → A8 Outcomes tile.
Execution rule: Run only the steps that touch your ASSIGNED_APP. Interactions with other apps must use their real staging endpoints. External third-party systems (outside A1–A8) may be safely stubbed as no-op test tenants while preserving real requests. Document any stubbing and ensure the Second-Confirmation Protocol is still satisfied with real A8 telemetry.
RL ERROR-CORRECTION LOOP

Implement: Monitor → Reflect (capture evidence and failure patterns) → Synthesize regression test (namespace=simulated_audit) → Propose PR (staging branch) → Verify (re-run tests; ensure SLO/EGRS improvement) → Update docs.
Reward signals:
Positive: Lower P95 latency vs baseline; reduced false positives; higher E2E pass rate; improved EGRS score; removal of ≥1 cost/perf hotspot.
Negative: Increased error rate; telemetry gaps to A8; unapproved production mutations; missing dual evidence.
Gate: No merges to main without HUMAN_APPROVAL_REQUIRED.
DELIVERABLES & REPORTING

Compute egrs_score.json using weights and thresholds:
Weights: Security 15, Auth_Health 10, Reliability 15, Observability 10, Data_Quality_A8 15, E2E_Workflows 15, Performance 10, Cost_Scale 5, Human_Gates 5.
Thresholds: Ready ≥ 85, Conditional ≥ 70, Not_Ready < 70.
Generate deliverables_global:
exec_summary.md
rca.md
system_map.json
connectivity_matrix.csv
slo_metrics.json
security_checklist.md
resiliency_config.md
e2e_results.json
a8_validation_results.json
a8_data_lineage.md
risk_register.md
cleanup_audit.sh (idempotent cleanup of synthetic test data; no production impact)
docs_update_plan.md
egrs_score.json
Generate deliverables_local per ASSIGNED_APP (see your app section above).
Generate three additional files:
false_positive_register.md (catalog suspected false positives, dual-evidence adjudication, resolution path)
readiness_attestation.md (APP-level PASS/FAIL with links to dual evidence)
ceo_promotion_checklist.md (gates to move from Diagnostic → Production Change Mode)
Generate a8_second_confirmation.md:
Authoritative PASS/FAIL for ecosystem readiness with dual evidence for liveness, autonomy, error-correction learning, reinforcement learning, and human-in-the-loop gates.
Include explicit verification of provider_fee_pct = 3 and ai_markup_factor = 4.0 lineage in Finance tile with matching event_id.
Reference all artifacts and dashboards used.
DATA LINEAGE TO A8

Validate Avro/JSON schemas; required tags {env, namespace, version}.
Confirm lineage: Source → A2 → A8 raw → A8 dashboards. Fix missing key fields in staging and re-validate. Update a8_data_lineage.md with the proof.
EXECUTION ORDER & STOP CONDITIONS

Execution order:
Global Discovery:
Build system_map.json and connectivity_matrix.csv; enumerate required secrets by name (presence-only); probe /health and /ready for all apps; snapshot SLOs (24h/7d if available).
App Diagnostics/Fixes:
Execute your app section; apply Staging Fix Mode; validate success_criteria with dual evidence; produce deliverables_local.
Global E2E:
Run FUNNEL-UNBLOCK protocol and the E2E workflows; confirm A8 SEO, Growth, Finance, and Outcomes tiles receive events with correct tags and financial fields.
Reporting & Cleanup:
Compute egrs_score.json; write exec_summary.md, a8_second_confirmation.md, and all required artifacts; run cleanup_audit.sh to remove synthetic staging data where safe and idempotent.
Stop conditions (immediately halt and request HUMAN_APPROVAL_REQUIRED):
Any action that would modify production (writes, deploys, configs).
Secret rotations/creations or scope escalations (A8 write scopes).
Schema or alert rule changes.
Deployment restarts or autoscale/cost-impacting changes.
Error rate ≥ 1% for > 5 minutes during tests.
Core auth (A1) or aggregator (A2) P95 > 200ms sustained during smoke/baseline.
Missing A8 telemetry for any executed test within 60 seconds.
Any sign of academic dishonesty enablement, data policy breach, or non-compliance (FERPA/COPPA).
Violation of Zero-Mock Rule or Second-Confirmation Protocol.
SUCCESS CRITERIA (GLOBAL)

All smoke/baseline SLOs met (P95 ≤ 150ms) with error rate < 1% across A1–A8.
A8 receives near-real-time telemetry for all apps with required tags and displays SEO, Growth, Finance, and Outcomes tiles populated for namespace=simulated_audit.
Finance lineage proves provider_fee_pct = 3 and ai_markup_factor = 4.0 via A6 logs and A8 Finance tile using an identical event_id.
RL signal path and error-correction learning loops documented and validated.
Human-in-the-loop gates enforced with approvals logged; zero unauthorized production mutations.
a8_second_confirmation.md states PASS with links to dual evidence; otherwise FAIL with a fix-forward plan, owners, and ETAs.