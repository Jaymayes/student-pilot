ğŸ¤– SYSTEM RESTORE + E2E: FEDERATED AUTH RECOVERY (MAX AUTONOMOUS)
SEVERITY: CRITICAL â€” FIX ALL ISSUES, VERIFY NO REVENUE BLOCKERS
MODE: MAX AUTONOMOUS (Selfâ€‘Identify â†’ Repair â†’ E2E Verify)

PURPOSE
- One prompt for all 8 apps. The Agent MUST selfâ€‘identify and execute ONLY its appâ€™s repair + E2E suite.
- Addresses: A1 dev crash (EADDRINUSE), A2 CORS defects, A6 prod 500/outâ€‘ofâ€‘sync, A7 admin auth gap, A3 OIDC discovery, A5/ A8 telemetry gating, and ecosystem CORS/JWKS resiliency.
- Finishes with hardened E2E checks and a revenueâ€‘blockers verdict.

0) SAFETY, SCOPE, REDACTION (APPLY TO EVERYTHING)
- Scope: Modify ONLY your current app. If any fix requires another app, file a ticket and STOP that change.
- Redact tokens, cookies, secrets, keys in output: ****
- Production safety: Prefer readâ€‘only checks; destructive operations must be isolated and cleaned up; use E2Eâ€‘[timestamp] data prefixes.
- Rate limiting: â‰¤ 1 RPS; exponential backoff on 429/503.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1) PHASE 1 â€” SELF IDENTIFICATION (MANDATORY)
TASK: Inspect package.json (name), environment (APP_ID/APP_NAME/APP_BASE_URL/REPL_SLUG), or directory to determine App ID.

APP REGISTRY
A1 = scholar_auth  â†’ https://scholar-auth-jamarrlmayes.replit.app
A2 = scholarship_api â†’ https://scholarship-api-jamarrlmayes.replit.app
A3 = scholarship_agent â†’ https://scholarship-agent-jamarrlmayes.replit.app
A4 = scholarship_sage â†’ https://scholarship-sage-jamarrlmayes.replit.app
A5 = student_pilot â†’ https://student-pilot-jamarrlmayes.replit.app
A6 = provider_register â†’ https://provider-register-jamarrlmayes.replit.app
A7 = auto_page_maker â†’ https://auto-page-maker-jamarrlmayes.replit.app
A8 = auto_com_center â†’ https://auto-com-center-jamarrlmayes.replit.app

REQUIRED HANDSHAKE (PRINT EXACTLY ONCE BEFORE ANY ACTIONS)
DETECTED APP ID: [A# / app name]
APP BASE URL: [exact URL from registry]
ACTION: Locking context. Executing only [this app] repair + E2E.

If multiple/no matches:
ABORT: Unable to determine single App ID with confidence. No actions executed.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2) PHASE 2 â€” REPAIR MISSIONS (EXECUTE ONLY YOUR APP SECTION)

ğŸ”· A1 scholar_auth (DEV CRASH; GLOBAL OIDC/CORS GATEKEEPER)
- Fix Dev Crash (EADDRINUSE):
  - If dev port (e.g., 3000/8080) in use â†’ kill orphan process (e.g., fuser -k 3000/tcp or pkill node on the specific PID).
  - Restart dev server; confirm local health.
- OIDC Discovery:
  - GET /oidc/.well-known/openid-configuration â†’ 200; issuer = https://scholar-auth-jamarrlmayes.replit.app/oidc
  - GET JWKS (jwks_uri) â†’ 200; â‰¥ 1 key; alg RS256 only (no HS256).
- CORS (ecosystem + custom domains):
  - Ensure allowlist includes these EXACT origins:
    - All 8 app URLs from registry
    - https://scholaraiadvisor.com and https://www.scholaraiadvisor.com
  - Credentials allowed for cookie flows; correct headers on OPTIONS.
- SQLi Regression Guard:
  - POST /api/auth/login with {"email":"e2e@test.com","password":"' OR '1'='1"} â†’ 401/400 expected.
  - If 500: add/ensure columns users.password_hash, users.ferpa_protected, users.ferpa_institution_id; retest (expect 401/400).
- Stripe in IdP (Publish blocker):
  - If Stripe deps/integration exist here, remove. This app is IdP only. If Replit UI integration blocks publish, remove integration and republish.
- Cookies/Headers:
  - Set-Cookie: Secure; HttpOnly; SameSite=None; trust proxy enabled. Enforce CSP, HSTS, X-Frame-Options (or frame-ancestors 'none'), nosniff.

ğŸ”· A2 scholarship_api (CORS DEFECT + LATENCY)
- CORS Fix:
  - Add exact origins: https://scholaraiadvisor.com, https://www.scholaraiadvisor.com, plus all 8 app URLs.
  - OPTIONS: include Access-Control-Allow-Headers: Authorization, Content-Type, X-App-ID, plus any custom used; allow credentials if needed.
- Search Latency:
  - /search?q=â€¦ < 400ms target; if â‰¥ 900ms, add/verify indexes (e.g., scholarships(title), scholarships(description) or full-text); retest.
- Telemetry S2S:
  - Ensure A5/A8 tokens/headers are accepted if applicable.

ğŸ”· A3 scholarship_agent (OIDC + TELEMETRY)
- OIDC Discovery Failures:
  - ISSUER_URL must be EXACT: https://scholar-auth-jamarrlmayes.replit.app/oidc (no trailing slash unless required; no spaces).
  - Restart app; verify /api/login â†’ 302/200 (not 5xx).
- Telemetry 403 to A8:
  - Ensure headers: Authorization: Bearer ****, X-App-ID: scholarship_agent, X-Protocol-Version: v3.5.1 (or current).
  - Implement retries/backoff; ensure circuit breaker.

ğŸ”· A4 scholarship_sage (SCOPE + UI)
- OIDC Scope:
  - Scope must be ['openid','email','profile'] only. Remove offline_access if present; redeploy.
- UI:
  - Ensure 401 states render CTA (no blank page). Ignore localhost 500s during dev login.

ğŸ”· A5 student_pilot (REVENUE FUNNEL)
- Env:
  - AUTH_ISSUER_URL = https://scholar-auth-jamarrlmayes.replit.app/oidc
- Stripe:
  - Ensure pk_live_ or pk_test_ present (redact in outputs). Checkout backend requires auth (401 when unauthenticated).
- Telemetry:
  - Confirm events reach A8 /ingest.

ğŸ”· A6 provider_register (PROD 500 / OUT-OF-SYNC)
- External Health:
  - GET https://provider-register-jamarrlmayes.replit.app/healthz â†’ 200 expected.
  - If 404/500: build locally (npm run build), then:
    - OUTPUT: "âš ï¸ ACTION REQUIRED: Republish in Replit UI to sync production with healthy build."
  - After publish, GET / â†’ 200; no error screen.
- Auth Flow:
  - /api/login â†’ 302 to A1; callback finalizes server session (no SPA race); CSRF & CORS correct for upload endpoints; Stripe Connect status OK.

ğŸ”· A7 auto_page_maker (ADMIN SECURITY)
- Harden /admin (server-side):
  - Add SSR middleware guard: if !authenticated â†’ 401/403. Do NOT rely on client-side redirect.
  - Verify public SEO endpoints unaffected: /sitemap.xml, /robots.txt, known SEO pages 200.
- Telemetry page-view OK.

ğŸ”· A8 auto_com_center (JWKS BACKOFF + REAL-TIME)
- JWKS Backoff:
  - Ensure retry with backoff; re-fetch https://scholar-auth-jamarrlmayes.replit.app/oidc/jwks.
- Real-Time:
  - SSE/WS endpoints stable â‰¥ 2s; webhook ingest 200; executive overview 200.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3) PHASE 3 â€” QUICK PRE-FLIGHT (COMMON)
- GET /health or /healthz â†’ 200
- Verify critical env secrets presence (print SET/MISSING only; never values):
  - IdP/ISSUER_URL, CLIENT_ID/SECRET, SESSION_SECRET, STRIPE keys (A5/A6 if applicable)
- DNS/Origin checks: Confirm APP_BASE_URL matches deploy.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4) PHASE 4 â€” E2E TESTING (EXECUTE ONLY YOUR APPâ€™S SUITE)

REPORT HEADER (prepend to logs)
E2E TEST REPORT
===============
APP ID: [Your App ID]
APP_BASE_URL: [Your Base URL]
TIMESTAMP: [ISO8601]
--------------------------------------------------

A1 scholar_auth (Auth, Tokens, Security)
- Frontend: Load / and login page â†’ 200; no console errors â‰¥ warn.
- OIDC/JWKS: Discovery 200; JWKS â‰¥ 1 key; RS256 only.
- Registration (non-destructive): unique email â†’ success/confirmation; Set-Cookie flags ok.
- Login:
  - Valid creds â†’ session established.
  - Invalid password â†’ 401; no cookie set.
- SQLi payload â†’ 401/400 (no 500).
- CORS spot check (OPTIONS) for ecosystem origins.

A2 scholarship_api (CRUD, Latency, Headers)
- Health: 200; DB=UP.
- Auth boundary:
  - GET /scholarships without Bearer â†’ 401 if protected, else document design.
- Read/Performance:
  - /scholarships?limit=10 â†’ 200; array; 3x average < 500ms.
  - /search?q=engineering â†’ < 400ms target (record result).
- CORS headers present (no wildcard with credentials).

A3 scholarship_agent (Jobs, Queues, Resilience)
- Health: 200; worker active.
- Job: trigger â†’ Queuedâ†’Processingâ†’Completed; backoff polling.
- Malformed job â†’ 4xx; process stays healthy.
- Telemetry to A8: accepted.

A4 scholarship_sage (Search UI)
- UI: / â†’ 200; input visible; no fatal console errors.
- Query: â€œFind me scholarships for engineeringâ€ â†’ non-empty response.
- Context: follow-up â€œWhat about nursing?â€ â†’ context shift understood.
- Mobile 375px: Send button visible and usable.

A5 student_pilot (Dashboard, Payments)
- Unauth /dashboard â†’ 302/307 to A1.
- Stripe key present (redacted).
- main.js/index.css â†’ 200; no 404.
- POST /api/checkout unauth â†’ 401.

A6 provider_register (Onboarding, Uploads)
- Root â†’ 200; no â€œApplication Errorâ€.
- /api/login â†’ 302 to A1; callback completes (session).
- OPTIONS /api/upload â†’ 200/204 with correct CORS.
- Stripe Connect status endpoint (if present) â†’ live, key_valid, webhook ok.

A7 auto_page_maker (CMS/SEO)
- /sitemap.xml â†’ 200; non-empty.
- /robots.txt â†’ 200; includes Sitemap.
- Known SEO page â†’ 200; non-empty <title>.
- /admin unauth â†’ 401/403 (server-side guard).

A8 auto_com_center (Messaging, Real-Time)
- /healthz â†’ 200 (status healthy).
- /api/telemetry/stream or /socket.io â†’ connects; initial event; â‰¥ 2s stable.
- Webhook ingest â†’ 200; persistence confirmed (if readable).

EVIDENCE (FOR EACH STEP)
- Log: Method, URL, Status, Duration(ms)
- Headers: capture Set-Cookie flags and CORS on relevant steps (no values)
- Assertion: expected vs observed (one sentence)
- Redact all secrets/tokens/cookie values â†’ ****

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

5) PHASE 5 â€” FINAL REVENUE BLOCKER CHECK (REQUIRED TABLE)

| Check                      | Status (PASS/FAIL/SKIP) | Risk  | Notes (Redacted)                           |
|---------------------------|--------------------------|-------|--------------------------------------------|
| Auth/Security (SQLi)      |                          | High  | A1 SQLi regression result                  |
| DB Connectivity           |                          | High  | /health DB=UP                              |
| Stripe/Revenue Key        |                          | High  | pk_live/pk_test present (A5/A6)            |
| Critical Assets (JS/CSS)  |                          | Med   | main.js/index.css 200                      |
| OIDC/JWKS Integrity       |                          | High  | Discovery ok; RS256 keys present           |
| CORS for Frontends        |                          | Med   | Exact origins; credentials as required     |
VERDICT: [READY FOR TRAFFIC / BLOCKED]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

6) PHASE 6 â€” AUTONOMOUS REPAIR REPORT (REQUIRED FORMAT)

ğŸ AUTONOMOUS REPAIR REPORT
APP ID: [Your ID]
ACTION TAKEN: [Files/config modified or "None"]
VERIFICATION: [Key health checks / E2E assertions]
STATUS: [FIXED / STABLE]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

7) PHASE 7 â€” ABORT CONDITIONS & TICKETS

ABORT (fail fast)
- Multiple/no App ID matches â†’ ABORT with candidate list.
- Repeated 5xx on critical paths (>2) â†’ stop writes, continue read-only checks; mark remaining as SKIPPED.

TICKET TEMPLATES (when crossâ€‘app changes are needed)
- A1 Client Registration Update â€” [Your App]
  - App: [Your App] | Base: [Your URL]
  - redirect_uris: ["[Your URL]/api/callback"]
  - post_logout_redirect_uris: ["[Your URL]"]
  - scopes: ["openid","email","profile"]
  - token_endpoint_auth_method: [client_secret_basic | none (PKCE)]
  - Evidence: invalid_redirect_uri / discovery mismatch (redacted)

- A2 CORS Allowlist â€” Add Custom/Ecosystem Origins
  - Origins to add: [exact list]
  - Evidence: OPTIONS/GET without Access-Control-Allow-Origin (redacted)

- A8 Telemetry Allowlist â€” Accept X-App-ID + Bearer
  - Need: Allow X-App-ID â€œ[Your App]â€; Authorization: Bearer ****
  - Evidence: 403 on /api/report or /ingest (redacted)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

8) PHASE 8 â€” ROLLBACK (IF NEEDED)
- Revert last config commit or deployment snapshot.
- Disable new env flags, restart service.
- Confirm rollback with /health and main route (200).

END OF PROTOCOL