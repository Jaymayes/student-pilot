ðŸ¤– SYSTEM RESTORE + FEDERATED E2E (MAX AUTONOMOUS) â€” CALLBACK FAILURE NOT FIXED
SEVERITY: P0 â€” Auth callback still failing (missing_parameters). Your task is to (1) explain why a real browser was not used previously, (2) run an enforced browser E2E on scholaraiadvisor.com, and (3) selfâ€‘identify your app and execute ONLY your repair mission + E2E.

0) SAFETY, SCOPE, REDACTION
- Scope: Modify ONLY your current app. If another app needs a change, open a ticket with evidence and STOP crossâ€‘app edits.
- Redact: tokens, codes, state, cookies, secrets â†’ ****
- Readâ€‘only by default. If a write is necessary, label â€œE2E Testâ€ and clean up.
- Rate limit: â‰¤ 1 RPS; exponential backoff on 429/503.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 0 â€” COMPLIANCE INTERROGATION (MANDATORY: ANSWER FIRST)
1) Why wasnâ€™t a REAL browser used previously for scholaraiadvisor.com?
   - Provide the exact reason (wrong target, Playwright not installed, headed blocked, etc.). Show the check/command output you used to detect it.

2) What changed so a browser WILL be used now?
   - Steps: npm i -D playwright; npx playwright install chromium; headed vs headless justification; xvfb if needed.

3) Print EXACTLY:
ACK: HTTP-only testing is forbidden for this run. I will use Playwright/Chromium.

If you cannot guarantee a browser, STOP and print:
> ABORT: Browser unavailable. Reason: [detail]. Remediation: [commands/settings]. Request approval to retry.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 1 â€” ENFORCED BROWSER E2E (scholaraiadvisor.com) â€” REPRODUCE CALLBACK FAILURE
Install/Provision:
- npm i -D playwright && npx playwright install chromium

Launch (headed preferred):
- 1280Ã—900, en-US. If headed fails: headless=true, justify.

PRINT BEFORE LAUNCH:
BROWSER RUN: Playwright/Chromium | headed=[true/false] | reason=[if false]

Capture artifacts to ./artifacts/:
- ConsoleAndNetwork.har (Home + Signâ€‘in + callback)
- Screenshots: home.png, auth-click.png, callback-error.png
- AuthFlowReport.json

Steps:
1) Open https://scholaraiadvisor.com â†’ assert 200; save home.png; capture console errors.
2) Click â€œSign in / Log inâ€ â†’ wait idle â†’ save auth-click.png. Record HTTP chain and final domain.
3) Click â€œContinue with [Provider]â€ WITHOUT real credentials; allow redirect back.
   - If you hit /auth|/api/callback?error=missing_parameters (or server_error), save callback-error.png and HAR.

AuthFlowReport.json (schema):
{
  "ctaText": "...",
  "startURL": "https://scholaraiadvisor.com",
  "authEntryURL": "https://scholar-auth-.../oidc/interaction/...",
  "finalCallbackURL": "https://scholar-auth-.../auth|api/callback?error=missing_parameters",
  "httpChain": ["..."],
  "visibleLoginUI": true/false,
  "errors": ["missing_parameters"|"server_error"|"..."],
  "observations": ["sanitized notes"]
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 2 â€” CALLBACK TRIAGE (WHY code/state ARE MISSING?)
A) HAR inspection (sanitized):
- Find the callback request. Record booleans for presence of code/state (and their lengths only).
- Note referrer and the last 302 Location (host+path only).

B) Redirect URI parity:
- Extract redirect_uri sent in the initial authorization request (host+path only).
- Compare with registered redirect_uris and your appâ€™s configured callback path:
  - Host mismatch? Path mismatch (/auth/callback vs /api/callback)? Trailing slash?

C) Cookie/SameSite at callback:
- Was the expected cookie sent at callback?
- Flags must include: Secure; HttpOnly; SameSite=None; Domain matches callback host.
- If cookie absent or SameSite != None â†’ state/PKCE cannot be restored.

D) PKCE/state persistence:
- Confirm serverâ€‘side persistence or stateless scheme that survives redirects.
- Clientâ€‘only storage (sessionStorage/localStorage) â†’ code/state lost on crossâ€‘domain redirect.

E) Middleware expectations:
- If the resume handler checks req.isAuthenticated(), ensure middleware sets req.isAuthenticated = () => !!req.user (Passport compatibility).

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 3 â€” SELFâ€‘IDENTIFICATION (STRICT LOGIC GATE)
TASK: Determine your App ID; execute ONLY that appâ€™s section below.

APP REGISTRY
A1 = scholar_auth        â†’ https://scholar-auth-jamarrlmayes.replit.app
A2 = scholarship_api     â†’ https://scholarship-api-jamarrlmayes.replit.app
A3 = scholarship_agent   â†’ https://scholarship-agent-jamarrlmayes.replit.app
A4 = scholarship_sage    â†’ https://scholarship-sage-jamarrlmayes.replit.app
A5 = student_pilot       â†’ https://student-pilot-jamarrlmayes.replit.app
A6 = provider_register   â†’ https://provider-register-jamarrlmayes.replit.app
A7 = auto_page_maker     â†’ https://auto-page-maker-jamarrlmayes.replit.app
A8 = auto_com_center     â†’ https://auto-com-center-jamarrlmayes.replit.app

PRINT EXACTLY BEFORE ACTIONS:
DETECTED APP ID: [A# / app name]
APP BASE URL: [exact URL from registry]
ACTION: Locking context. Executing only [this app] repair + E2E.

If multiple/no matches:
ABORT: Unable to determine single App ID with confidence. No actions executed.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 4 â€” REPAIR MISSIONS (EXECUTE ONLY YOUR APP SECTION)

ðŸ”· A1 scholar_auth (OIDC GATEKEEPER & CALLBACK DIAGNOSTICS)
- Callback Diagnostics (CRITICAL)
  - Ensure logging at /auth|/api/callback captures: hasCode/hasState, lengths, referer, hostname, protocol, queryKeys (names only).
- CORS Allowlist
  - Allow EXACT origins: https://scholaraiadvisor.com, https://www.scholaraiadvisor.com, plus all 8 app URLs; credentials allowed; OPTIONS correct.
- OIDC Discovery
  - /.well-known/openid-configuration â†’ 200; JWKS â†’ 200; alg RS256 only.
- Dev Health (optional)
  - If EADDRINUSE on 3000/8080 â†’ kill orphan and restart.

ðŸ”· A2 scholarship_api (CORS + SEARCH LATENCY)
- CORS: allow scholaraiadvisor.com and www; OPTIONS must include Authorization, Content-Type, X-App-ID.
- Latency: /search?q=engineering < 400ms; if â‰¥ 900ms â†’ add/verify indexes/fullâ€‘text.

ðŸ”· A3 scholarship_agent (OIDC + TELEMETRY)
- ISSUER_URL EXACT: https://scholar-auth-jamarrlmayes.replit.app/oidc; /api/login â†’ 302/200.
- Telemetry to A8: Authorization: Bearer ****; X-App-ID: scholarship_agent.

ðŸ”· A4 scholarship_sage (SCOPE + UI)
- Scope: ['openid','email','profile'] only (no offline_access).
- 401 UX: show clear â€œSign inâ€ CTA.

ðŸ”· A5 student_pilot (REVENUE FUNNEL)
- AUTH_ISSUER_URL = https://scholar-auth-jamarrlmayes.replit.app/oidc
- Stripe key present (redacted). POST /api/checkout (unauth) â†’ 401.
- Telemetry reaches A8 /ingest.

ðŸ”· A6 provider_register (PROD 500 / OUTâ€‘OFâ€‘SYNC)
- /healthz â†’ 200; if 404/500, build locally & advise republish.
- /api/login â†’ 302 to A1; OPTIONS /api/upload â†’ 200/204 with proper CORS.

ðŸ”· A7 auto_page_maker (ADMIN SECURITY)
- /admin must be serverâ€‘guarded â†’ 401/403 when unauth.
- SEO endpoints intact: /sitemap.xml, /robots.txt â†’ 200.

ðŸ”· A8 auto_com_center (JWKS + REALâ€‘TIME)
- JWKS retry/backoff for A1.
- SSE/WS stable â‰¥ 2s; webhook ingest 200.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 5 â€” QUICK PREâ€‘FLIGHT (COMMON)
- GET /health or /healthz â†’ 200
- Secrets presence (print SET/MISSING only)
- Confirm APP_BASE_URL matches deployed origin.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 6 â€” APP E2E (EXECUTE ONLY YOUR SUITE)

REPORT HEADER
E2E TEST REPORT
===============
APP ID: [Your App ID]
APP_BASE_URL: [Your Base URL]
TIMESTAMP: [ISO8601]
--------------------------------------------------

A1 scholar_auth
- Load / â†’ 200; OIDC discovery â†’ 200; JWKS â†’ 200
- CORS preflight for https://scholaraiadvisor.com â†’ 200/204
- Confirm callback diagnostic logs present (check recent log lines)

A2 scholarship_api
- /health â†’ 200; /search latency < 400ms; CORS for custom domains present

A3 scholarship_agent
- /health â†’ 200; /api/login â†’ 302/200; telemetry accepted by A8

A4 scholarship_sage
- / â†’ 200; search input visible; unauth search â†’ expected behavior (401/guard)

A5 student_pilot
- Unauth /dashboard â†’ 302/307 to A1; Stripe key present (redacted); /api/checkout (unauth) â†’ 401

A6 provider_register
- Root â†’ 200; /api/login â†’ 302 to A1; OPTIONS /api/upload â†’ 200/204

A7 auto_page_maker
- /sitemap.xml â†’ 200; /admin (unauth) â†’ 401/403 (server guard enforced)

A8 auto_com_center
- /healthz â†’ 200; webhook ingest â†’ 200; JWKS fetch â†’ 200

Log for each step:
- METHOD URL | status=___ | time=___ms | assertion=[expected vs observed]
- Include security/CORS headers snapshots (no cookie values).

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 7 â€” FINAL REVENUE BLOCKER CHECK
| Check                      | Status (PASS/FAIL/SKIP) | Risk | Notes (Redacted)                         |
|---------------------------|--------------------------|------|------------------------------------------|
| Callback receives code/state (A1) |                | High | A1 diag logs / HAR evidence               |
| OIDC/JWKS Integrity       |                          | High | Discovery OK; RS256 keys present         |
| CORS for Frontends        |                          | Med  | Exact origins (incl. custom domains)     |
| Stripe/Revenue Key        |                          | High | A5/A6 keys present / auth gating         |
| Critical Assets (JS/CSS)  |                          | Med  | main.js/index.css 200                    |

VERDICT: [READY FOR TRAFFIC / BLOCKED]

If BLOCKED, link tickets with precise, sanitized evidence.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 8 â€” AUTONOMOUS REPAIR REPORT (REQUIRED)
ðŸ AUTONOMOUS REPAIR REPORT
APP ID: [Your ID]
ACTION TAKEN: [Files/config modified or "None"]
VERIFICATION: [Key health checks / E2E assertions]
STATUS: [FIXED / STABLE]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 9 â€” TICKETS (WHEN CROSSâ€‘APP CHANGES ARE NEEDED)
- Auth Callback â€” missing_parameters (Production)
  - Symptom: /auth|/api/callback?error=missing_parameters
  - Root cause(s): RC1/RC2/RC3/RC4/RC7
  - Evidence (sanitized): finalCallbackURL, redirect_uri (host+path), cookie flags on callback, HAR row indexes
  - Fix: Align redirect_uri; set SameSite=None; serverâ€‘side PKCE/state; req.isAuthenticated polyfill; env guards

- A2 CORS Allowlist â€” scholaraiadvisor.com/www
  - Evidence: OPTIONS/GET lacks Access-Control-Allow-Origin

- A8 Telemetry Allowlist â€” Bearer + X-App-ID
  - Evidence: 403 on /api/report or /ingest

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PHASE 10 â€” ROLLBACK (IF NEEDED)
- Revert last config or deployment snapshot.
- Disable new env flags; restart; confirm /health and main route 200.

END OF PROMPT â€” Execute now in MAX Autonomous mode.