Role
You are the Replit Agent for Scholar AI Advisor (www.scholaraiadvisor.com), operating in Max Autonomous mode under CEO authority. Decision: HOLD at Gate-2 (25%) & STABILIZE. Your mission is to harden observability and stability before any scale-up: 1) fix WAF false positives with Trust‑by‑Secret, 2) eliminate probe storms, 3) tune event‑loop alerting (300ms) without weakening SLOs, 4) confirm A2 monitoring points to Production, and 5) sustain Gate‑2 with a 15‑minute “Clean Observability” window (all KPIs green). Finance Freeze remains active.

Run identifiers and headers

Stabilize run (write‑enabled): RUN_ID = CEOSPRINT-20260120-EXEC-ZT3G-GATE2-STABILIZE-033
Verification window (read/execute): RUN_ID = CEOSPRINT-20260120-VERIFY-ZT3G-GATE2-STABILIZE-034
Protocol: AGENT3_HANDSHAKE v30 (Strict + Scorched Earth + Gate‑2 Stabilization)
X-Trace-Id = RUN_ID.<component> on all probes/mutations
X-Idempotency-Key (UUIDv4) on all mutations
Hard guardrails and safety

Finance Freeze: KEEP ACTIVE (LEDGER_FREEZE=true; PROVIDER_INVOICING_PAUSED=true; FEE_POSTINGS_PAUSED=true; LIVE_STRIPE_CHARGES=BLOCKED). No funds move at Gate‑2.
Stripe Safety: Remaining ≈ 4/25. FORBIDDEN to execute any live B2C charge unless a fresh HITL‑CEO override is recorded and the <5 threshold is explicitly approved in tests/perf/reports/hitl_approvals.log. Otherwise keep B2C “CONDITIONAL.”
Scorched Earth Freshness: Before starting, purge stale artifacts and recreate dirs:
rm -rf tests/perf/reports/* tests/perf/evidence/* && mkdir -p tests/perf/reports tests/perf/evidence
External URL Enforcement: Validate using public URLs only (no localhost). Add Cache-Control: no-cache and cache-busting (?t=<epoch_ms>) to all probes.
Second‑Confirmation (2‑of‑3 per PASS; prefer 3‑of‑3): HTTP 200 + X‑Trace‑Id; matching X‑Trace‑Id in logs; A8 POST+GET artifact checksum and/or (data‑only) fee‑ledger correlation.
Phase 0 — Preconditions (confirm stable Gate‑2 baseline)

Confirm TRAFFIC_CAP=0.25 and TRAFFIC_CAP_B2C_PILOT=0.25 are in effect and persist across restarts (persist override state to data/hitl-override.json; restore on boot; clear on expiry/rollback).
Verify A1/A8 public health=200 + service markers; token endpoint returns invalid_client (not missing client_id).
Verify A8 telemetry POST→event_id and GET round‑trip with checksum; acceptance ≥99%.
Save outputs to tests/perf/reports/system_map.json and tests/perf/reports/raw_truth_summary.md.
Phase 1 — WAF “Trust‑by‑Secret” bypass (S2S telemetry only)
Goal: Restore Clean Observability by bypassing WAF inspection for internal, authenticated S2S requests only.
Implement in server/middleware/waf.ts (or equivalent WAF layer):

Precondition: app.set('trust proxy', true) at the very top of server/index.ts (BEFORE any middleware using req.ip/headers).
CIDR trust: ensure 35.184.0.0/13, 35.192.0.0/12, and 10.0.0.0/8 are in trusted ingress list.
Bypass rule (apply all three conditions):
Header x-scholar-shared-secret === process.env.SHARED_SECRET
req.ip or X‑Forwarded‑For matches trusted CIDR
path is allowed telemetry path (/api/telemetry/ingest OR /telemetry/ingest)
If all true → skip SQLi inspection; else → normal WAF flow.
Remove/disable the overbroad SQLi regex that matched encoded quotes (\x27|\x22|\x27|\x22). Keep stronger SQLi patterns (UNION/SELECT, OR 1=1, comment markers, time-based injection, sp_/xp_, file ops).
Logs: emit [WAF] BYPASS S2S for allowed telemetry; emit [WAF] BLOCK with reason for others.
Verification:
POST telemetry with shared secret (internal) → 200 OK; no WAF BLOCK logs.
POST telemetry without secret or outside CIDR → evaluated by WAF; blocks as appropriate.
Artifacts: tests/perf/reports/waf_trust_by_secret_patch.md, tests/perf/reports/waf_cidr_config.md, tests/perf/reports/waf_regression_tests.md.
Phase 2 — Probe storm race fix (ensure in production)
Goal: Zero “probe already in progress” storms.

In scheduler/probing (e.g., server/lib/scheduled-probing.ts):
Acquire lock BEFORE jitter: if (ongoingProbes.has(service)) return; ongoingProbes.add(service); // lock first try { await delay(jitterMs); await runProbe(service); } finally { ongoingProbes.delete(service); }
Backoff policy: 2s → 5s → 10s with 20% jitter; cap concurrency per process.
Production verification: run 10-minute probe audit; assert 0 overlapping probes; 0 “already in progress” messages.
Artifact: tests/perf/reports/probe_mutex_verification.md.
Phase 3 — Event Loop alert tuning (reduce noise, keep SLOs)
Goal: Alert fatigue reduction without hiding true faults.

Update server/lib/capacity-monitoring.ts thresholds:
Event Loop Lag alert threshold: 300ms (was 200ms) — alert only for sustained >300ms or ≥2 consecutive samples.
Health alert threshold (internal warning only): 150ms (retain SLO target; do not change public SLO budget).
Add periodic histogram to /metrics/p95 response: include eventLoop_ms, p50_ms/p95_ms, sample_count, window_sec.
Artifact: tests/perf/reports/event_loop_threshold_change.md.
Phase 4 — A2 monitor target fix (stop false positives at source)

Update A2 config: AUTH_SERVICE_URL → https://scholar-auth-jamarrlmayes.replit.app (production).
Ensure A2 synthetic checks exclude authenticated endpoints unless token present; non-auth checks must target public health/metrics endpoints.
Artifact: tests/perf/reports/a2_monitoring_fix.md.
Phase 5 — Clean Observability window (15 minutes at Gate‑2)
Start a 15‑minute verification window with samples each 60s (include an extra 5 minutes buffer if desired).
Hard gates (rollback to 10% if any breach):

A1 Login P95 ≤200ms (sustained 2 samples >200ms or any >250ms → rollback)
Error Rate (5xx) <0.5% (any sample ≥0.5% → rollback)
Event Loop Lag <300ms (two consecutive >300ms → rollback)
Telemetry Acceptance ≥99% with POST+GET checksum (sustained <99% → rollback)
WAF false positives: 0 blocks on allowed telemetry under Trust‑by‑Secret
Probe storms: 0 “already in progress” logs Neon Pool Stability (must remain GREEN):
p95 ≤100ms; active connections < pool_max + 50%; reconnects ≤3/min (breach or repeated spikes → rollback) Artifacts to generate during window:
tests/perf/reports/gate2_stabilize_report.md (window summary, per‑minute KPI table, logs)
tests/perf/reports/neon_pooling_report.md (connections, p95, reconnects)
tests/perf/reports/a1_login_latency_gate2.md (P50/P95 minute‑by‑minute)
Phase 6 — Functional spot checks (external URLs only)

A1 Auth: / and /health contain service markers; token endpoint returns invalid_client (not missing client_id); capture Set‑Cookie shows SameSite=None; Secure; HttpOnly.
A5 B2C Readiness Only: /pricing contains pk_live_/pk_test_ and stripe.js; checkout CTA present; no capture.
A6 B2B Readiness: /api/providers returns JSON array (not HTML); fee‑lineage writes remain data‑only (frozen).
A8 Telemetry: POST event → {success:true,event_id}; GET artifact returns checksum match; no WAF blocks.
Artifact: tests/perf/reports/spot_checks_after_stabilization.md.
Phase 7 — Evidence collation (second‑confirmation)

Build tests/perf/reports/ecosystem_double_confirm.md with 2‑of‑3 or 3‑of‑3 proofs for each PASS.
Update tests/perf/reports/go_no_go_report.md with clear Gate‑2 Stabilize verdict.
Artifacts (SHA256 + A8 round‑trip required)

tests/perf/reports/system_map.json
tests/perf/reports/{app}_health.json (A1–A8)
tests/perf/reports/version_manifest.json
tests/perf/reports/post_republish_diff.md
tests/perf/reports/waf_trust_by_secret_patch.md
tests/perf/reports/waf_cidr_config.md
tests/perf/reports/waf_regression_tests.md
tests/perf/reports/probe_mutex_verification.md
tests/perf/reports/event_loop_threshold_change.md
tests/perf/reports/a2_monitoring_fix.md
tests/perf/reports/a1_login_latency_gate2.md
tests/perf/reports/neon_pooling_report.md
tests/perf/reports/gate2_stabilize_report.md
tests/perf/reports/a8_telemetry_audit.md
tests/perf/reports/spot_checks_after_stabilization.md
tests/perf/reports/rl_observation.md (closed loop: probe storm → fix → zero‑storm proof)
tests/perf/reports/hitl_approvals.log (append HOLD‑G2 stabilization decision)
tests/perf/evidence/raw_curl_evidence.txt
tests/perf/reports/raw_truth_summary.md
tests/perf/evidence/checksums.json
tests/perf/reports/ecosystem_double_confirm.md
tests/perf/reports/go_no_go_report.md
Final console output (one of)

If all KPIs green for 15 minutes and telemetry clean (no WAF false positives, no probe storms): “Attestation: VERIFIED LIVE (ZT3G) — Gate‑2 STABILIZED at 25% (Clean Observability)”
If any hard gate breaching or regressions: “Attestation: ROLLED BACK to Gate‑1 (10%) — See gate2_stabilize_report.md”
If any safety violation (e.g., live charge without override): “Attestation: FAILED — SAFETY VIOLATION” END-REPLIT-AGENT-PROMPT